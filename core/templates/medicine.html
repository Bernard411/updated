{% load static %}
{% include 'header.html' %}

<section class="home" id="home">
 
    
  </section>


      
<!DOCTYPE html> 
<html lang="en"> 

<head> 
	
	<!-- Font Awesome CSS CDN -->
	<link rel="stylesheet" href= 
"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
			integrity= 
"sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
		crossorigin="anonymous" referrerpolicy="no-referrer" /> 
	<link rel="stylesheet" href="/style2.css"> 
</head> 

<body> 
	<div class="app" style="background-color: #07181f; width: auto; margin-left: 20px; margin-right: 20px;"> 
		<h1>health tracker</h1>
		<div class="inputs"> 
			<div> 
				<label for="water">  
					Water Intake (in ml) 
				</label> 
				<input id="water" type="number"> 
			</div> 
			<div> 
				<label for="exercise"> 
					Exercise Duration (in min) 
				</label> 
				<input id="exercise" type="number"> 
			</div> 
			<div> 
				<label for="bloodsugerlevel"> 
					Blood Sugar Level (in mg/dL) 
				</label> 
				<input id="bloodsugerlevel" type="number"> 
			</div> 
		</div> 
		<button id="submit">Submit</button> 
		<div id="editSection" class="hidden"> 
			<button id="cancelEdit" onclick="cancelEdit()"> 
				Cancel 
			</button> 
			<button id="updateEntry" onclick="editRow()"> 
				Update 
			</button> 
		</div> 
		<table> 
			<thead> 
				<tr> 
					<th>Date</th> 
					<th>Water Intake <br> (in ml)</th> 
					<th>Exercise Duration <br> (in min)</th> 
					<th>Blood Sugar Level <br> (in mg/dL)</th> 
					<th>Edit</th> 
					<th>Delete</th> 
				</tr> 
			</thead> 
			<tbody id="output"> 
			</tbody> 
		</table> 
	</div> 
	<!-- Font Awesome JS CDN -->
	<script src= 
"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"
			integrity= 
"sha512-GWzVrcGlo0TxTRvz9ttioyYJ+Wwk9Ck0G81D+eO63BaqHaJ3YZX9wuqjwgfcV/MrB2PhaVX9DkYVhbFpStnqpQ=="
			crossorigin="anonymous" referrerpolicy="no-referrer"> 
	</script> 
	<script src="/script2.js"></script> 
</body> 

</html>
<style>


h1 { 
	background-image: linear-gradient(to right, #0ea5e9, #10b981); 
} 

h3 { 
	background-image: linear-gradient(to right, #ec4899, #8b5cf6); 
} 

h1, 
h3 { 
	color: transparent; 
	background-clip: text; 
	-webkit-background-clip: text; 
	-webkit-text-fill-color: transparent; 
} 

.app { 
	display: flex; 
	flex-direction: column; 
	justify-content: center; 
	align-items: center; 
	width: 650px; 
	margin: 1rem auto; 
	padding: 10px; 
	gap: 20px; 
} 

.inputs { 
	width: 100%; 
	display: flex; 
	justify-content: space-between; 
	align-items: center; 
	gap: 20px; 
	height: fit-content; 
} 

.inputs>div { 
	height: 100%; 
	display: flex; 
	justify-content: space-between; 
	flex-direction: column; 
} 

label { 
	font-size: 0.9rem; 
    color: white;
} 

input, 
label { 
	display: block; 
} 

input { 
	margin-top: 8px; 
	margin-bottom: 5px; 
	padding: 10px; 
	font-size: large; 
	background-color: #262626; 
	color: white; 
	border: none; 
	border-radius: 5px; 
	width: 100%; 
} 

input:focus-visible { 
	outline: 2px solid #ec4899; 
} 

input::-webkit-outer-spin-button, 
input::-webkit-inner-spin-button { 
	-webkit-appearance: none; 
	margin: 0; 
} 

button{ display: block; cursor: pointer; border: none; } 

#submit { 
	width: 100%; 
	padding: 10px; 
	margin-bottom: 10px; 
	background-image: linear-gradient(to right, #ec4899, #8b5cf6); 
	font-size: 1.3rem; 
	border-radius: 5px; 
	color: white; 
	font-weight: bold; 
	transition: scale 0.3s ease-in-out; 
} 

#editSection{ 
	width: 100%; 
	display: flex; 
	gap: 25px; 
	justify-content: space-between; 
} 

#editSection > button { 
	width: 100%; 
	padding: 10px; 
	margin-bottom: 10px; 
	font-size: 1.3rem; 
	border-radius: 5px; 
	color: white; 
	font-weight: bold; 
	transition: scale 0.3s ease-in-out; 
} 

#updateEntry { background-image: 
	linear-gradient(to right, #ec4899, #8b5cf6); } 

#cancelEdit{ background-color: #ef4444; } 

#submit:hover, #updateEntry:hover, #cancelEdit:hover { scale: 1.02; } 

.hidden{ display: none !important; } 

.edit, .delete{ 
	margin: 0 auto; 
	padding: 5px 10px; 
	font-size: 1.1rem; 
	border-radius: 5px; 
	background-color: transparent; 
	color: white; 
	border: 1px solid white; 
} 

.edit:hover, .delete:hover{ 
	background-color: #0a0a0a; 
} 

table { 
	width: 100%; 
	border-collapse: collapse; 
	position: relative; 
	overflow: hidden; 
} 

th, 
td { 
	text-align: center; 
	padding: 10px; 
	border: 0; 
    color: white;
} 
tr:nth-child(even) { 
	background-color: #57534e; 
} 

tr:nth-child(odd) { 
	background-color: #262626; 
} 

th { 
	font-size: 0.9rem; 
	background-color: #0a0a0a; 
} 

tbody > tr:hover{ 
	background-color: #737373; 
	color: black; 
} 

.delete-animation{ 
	background-color: #ef4444 !important; 
	animation: deleteAnimate 0.4s linear forwards; 
} 

@keyframes deleteAnimate{ 
	to{ 
		transform: translateX(100%); 
	} 
}

</style>
<script>
    // script.js 

const editIcon = `<i class="fas fa-edit"></i>` 

const deleteIcon = `<i class="fas fa-trash"></i>` 

function clearInputs() { 
	wInput.value = ""
	eInput.value = ""
	bInput.value = ""
} 

function addToLocalStorage(){ 
	localStorage.setItem("date", JSON.stringify(date)) 
	localStorage.setItem("water", JSON.stringify(water)) 
	localStorage.setItem("exercise", JSON.stringify(exercise)) 
	localStorage.setItem("bloodsugar", JSON.stringify(bloodsugar)) 
} 

function activateEdit(i){ 
	wInput.value = water[i] 
	eInput.value = exercise[i] 
	bInput.value = bloodsugar[i] 
	editIndex = i 
	submitButton.classList.add("hidden") 
	editSection.classList.remove("hidden") 
} 

function cancelEdit() { 
	clearInputs() 
	editIndex = -1 
	submitButton.classList.remove("hidden") 
	editSection.classList.add("hidden") 
} 

function editRow(){ 
	if(editIndex==-1) return
	water[editIndex] = wInput.value 
	exercise[editIndex] = eInput.value 
	bloodsugar[editIndex] = bInput.value 
	fillTable() 
	addToLocalStorage() 
	cancelEdit() 
} 

function deleteRow(i){ 
	if(!confirm( 
	`Confirm that you want to delete the entry: 
	\n ${date[i]}: ${water[i]}ml, ${exercise[i]}min, 
${bloodsugar[i]}mg/dL`)) 
return
	date.splice(i, 1) 
	water.splice(i, 1) 
	exercise.splice(i, 1) 
	bloodsugar.splice(i, 1) 
document.querySelector(`#output > tr:nth-child(${i+1})`) 
	.classList.add("delete-animation") 
	addToLocalStorage() 
	setTimeout(fillTable, 500) 
} 

function fillTable(){ 
	const tbody = document.getElementById("output") 
	const rows = 
		Math.max(water.length, exercise.length, bloodsugar.length) 
	let html = ""
	for(let i=0; i<rows; i++){ 
		let w = water[i] || "N/A"
		let e = exercise[i] || "N/A"
		let b = bloodsugar[i] || "N/A"
		let d = date[i] || "N/A"
		html+=`<tr> 
			<td>${d}</td> 
			<td>${w}</td> 
			<td>${e}</td> 
			<td>${b}</td> 
			<td> 
				<button onclick="activateEdit(${i})"
						class="edit">${editIcon} 
				</button> 
			</td> 
			<td> 
				<button 
					onclick="deleteRow(${i})"
					class="delete">${deleteIcon} 
				</button> 
			</td> 
		</tr>`		 
	} 
	tbody.innerHTML = html; 
} 

let editIndex = -1; 

let date = 
	JSON.parse(localStorage.getItem("date")) || [] 
let water = 
	JSON.parse(localStorage.getItem("water")) || [] 
let exercise = 
	JSON.parse(localStorage.getItem("exercise")) || [] 
let bloodsugar = 
	JSON.parse(localStorage.getItem("bloodsugar")) || [] 

const wInput = document.getElementById("water") 
const eInput = document.getElementById("exercise") 
const bInput = document.getElementById("bloodsugerlevel") 

const submitButton = document.getElementById("submit") 
const editSection = document.getElementById("editSection") 

fillTable() 

submitButton.addEventListener("click", ()=>{ 
	const w = wInput.value || null; 
	const e = eInput.value || null; 
	const b = bInput.value || null; 
	if(w===null || e===null || b===null) { 
		alert("Please enter all the fields.") 
		return
	} 
	const d = new Date().toLocaleDateString() 
	date = [d, ...date] 
	water = [w, ...water] 
	exercise = [e, ...exercise] 
	bloodsugar = [b, ...bloodsugar] 
	// date.push(d) 
	// water.push(w) 
	// exercise.push(e) 
	// bloodsugar.push(b) 
	clearInputs() 
	fillTable() 
	addToLocalStorage() 
})

</script>
    </div>
	<section class="icons-container">
		<!DOCTYPE html>
		<html lang="en">
		<head>
			<meta charset="UTF-8">
			<meta name="viewport" content="width=device-width, initial-scale=1.0">
			<title>Health Monitor</title>
			<style>
				body {
					font-family: Arial, sans-serif;
					text-align: center;
					margin: 0;
					padding: 0;
					background-color: #f0f0f0;
				}
				h1 {
					margin-top: 20px;
				}
				video {
					display: block;
					margin: 20px auto;
					width: 320px;
					height: 240px;
					border: 2px solid #ccc;
				}
				button {
					margin: 20px auto;
					padding: 10px 20px;
					font-size: 16px;
				}
				#result {
					font-size: 18px;
					margin-top: 20px;
				}
				canvas {
					display: block;
					margin: 20px auto;
					border: 2px solid #ccc;
					background-color: #000;
				}
				.warning {
					color: red;
					font-weight: bold;
				}
			</style>
		</head>
		<body>
			<!-- <h1>Heart Rate Monitor</h1> -->
			<video id="video" autoplay></video>
			<button id="startHeartButton">Start Monitoring Heart Rate</button>
			<div id="heartResult"></div>
		
			<!-- <h1>Respiratory Rate Monitor</h1> -->
			<button id="startRespiratoryButton">Start Monitoring Respiratory Rate</button>
			<button id="stopRespiratoryButton" style="display: none;">Stop Monitoring</button>
			<canvas id="waveform" width="600" height="200"></canvas>
			<div id="respiratoryResult">Press Start to monitor respiratory rate</div>
			<div id="respiratoryWarningMessage" class="warning" style="display: none;">Warning: High Respiratory Rate Detected!</div>
			<div id="respiratoryRecommendation"></div>
		
			<script>
				// Heart Rate Monitor
				document.getElementById('startHeartButton').addEventListener('click', async () => {
					const video = document.getElementById('video');
					const resultDiv = document.getElementById('heartResult');
		
					try {
						const stream = await navigator.mediaDevices.getUserMedia({ video: true });
						video.srcObject = stream;
		
						const canvas = document.createElement('canvas');
						const context = canvas.getContext('2d');
						const width = 320;
						const height = 240;
						canvas.width = width;
						canvas.height = height;
		
						let frameCount = 0;
						let sum = 0;
						let lastAverage = 0;
						const frameRate = 30; // frames per second
		
						function analyzeFrame() {
							context.drawImage(video, 0, 0, width, height);
							const imageData = context.getImageData(0, 0, width, height);
							const data = imageData.data;
		
							let averageColor = 0;
							for (let i = 0; i < data.length; i += 4) {
								averageColor += (data[i] + data[i + 1] + data[i + 2]) / 3;
							}
							averageColor /= (data.length / 4);
		
							sum += Math.abs(averageColor - lastAverage);
							lastAverage = averageColor;
							frameCount++;
		
							if (frameCount === frameRate) {
								const bpm = (sum / frameRate) * 60;
								resultDiv.innerText = `Estimated Heart Rate: ${Math.round(bpm)} BPM`;
								frameCount = 0;
								sum = 0;
							}
		
							requestAnimationFrame(analyzeFrame);
						}
		
						requestAnimationFrame(analyzeFrame);
					} catch (error) {
						console.error("Error accessing camera: ", error);
						resultDiv.innerText = "Error accessing camera";
					}
				});
		
				// Respiratory Rate Monitor
				let isMonitoring = false;
				let audioContext;
				let analyser;
				let dataArray;
				let breathRates = [];
				let highRateWarning = false;
				let recommendationTimeout;
		
				const beepSound = new Audio('https://www.soundjay.com/button/beep-07.wav');
		
				document.getElementById('startRespiratoryButton').addEventListener('click', async () => {
					const resultDiv = document.getElementById('respiratoryResult');
					const canvas = document.getElementById('waveform');
					const warningMessage = document.getElementById('respiratoryWarningMessage');
					const recommendationDiv = document.getElementById('respiratoryRecommendation');
					const stopButton = document.getElementById('stopRespiratoryButton');
		
					try {
						const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
						audioContext = new (window.AudioContext || window.webkitAudioContext)();
						analyser = audioContext.createAnalyser();
						const source = audioContext.createMediaStreamSource(stream);
						source.connect(analyser);
		
						analyser.fftSize = 256;
						const bufferLength = analyser.frequencyBinCount;
						dataArray = new Uint8Array(bufferLength);
		
						let breathTimestamps = [];
						let lastBreathTime = 0;
		
						function draw() {
							analyser.getByteTimeDomainData(dataArray);
		
							const canvasCtx = canvas.getContext('2d');
							canvasCtx.fillStyle = 'black';
							canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
		
							canvasCtx.lineWidth = 2;
							canvasCtx.strokeStyle = 'lime';
		
							canvasCtx.beginPath();
							const sliceWidth = canvas.width / bufferLength;
							let x = 0;
		
							let breathDetected = false;
		
							for (let i = 0; i < bufferLength; i++) {
								const v = dataArray[i] / 128.0;
								const y = (v * canvas.height) / 2;
		
								if (i === 0) {
									canvasCtx.moveTo(x, y);
								} else {
									canvasCtx.lineTo(x, y);
								}
		
								// Detect breath based on amplitude threshold
								if (v > 1.5 && !breathDetected) {
									const currentTime = audioContext.currentTime;
									if (currentTime - lastBreathTime > 1) {
										breathTimestamps.push(currentTime);
										lastBreathTime = currentTime;
										breathDetected = true;
									}
								}
		
								x += sliceWidth;
							}
		
							canvasCtx.lineTo(canvas.width, canvas.height / 2);
							canvasCtx.stroke();
		
							// Calculate respiratory rate
							breathTimestamps = breathTimestamps.filter(ts => audioContext.currentTime - ts < 60);
							const breathRate = breathTimestamps.length;
							resultDiv.innerText = `Respiratory Rate: ${breathRate} breaths per minute`;
		
							// Update breath rates array
							breathRates.push(breathRate);
							if (breathRates.length > 10) {
								breathRates.shift(); // Keep the last 10 rates
							}
		
							const averageBreathRate = breathRates.reduce((a, b) => a + b, 0) / breathRates.length;
		
							// Check for high respiratory rate
							if (averageBreathRate > 20) {
								if (!highRateWarning) {
									highRateWarning = true;
									warningMessage.style.display = 'block';
									beepSound.play();
		
									recommendationDiv.innerText = "Recommendation: Take a moment to rest. If the problem persists, consider contacting a healthcare professional.";
									recommendationDiv.style.display = 'block';
		
									// Automatically hide warning and recommendation after 10 seconds
									recommendationTimeout = setTimeout(() => {
										warningMessage.style.display = 'none';
										recommendationDiv.style.display = 'none';
										highRateWarning = false;
									}, 10000);
								}
							} else {
								if (highRateWarning) {
									warningMessage.style.display = 'none';
									recommendationDiv.style.display = 'none';
									highRateWarning = false;
									clearTimeout(recommendationTimeout);
								}
							}
		
							if (isMonitoring) {
								requestAnimationFrame(draw);
							}
						}
		
						isMonitoring = true;
						draw();
		
						stopButton.style.display = 'inline';
						document.getElementById('startRespiratoryButton').style.display = 'none';
					} catch (error) {
						console.error("Error accessing microphone: ", error);
						resultDiv.innerText = "Error accessing microphone";
					}
				});
		
				document.getElementById('stopRespiratoryButton').addEventListener('click', () => {
					isMonitoring = false;
					clearTimeout(recommendationTimeout);
					audioContext.close().then(() => {
						console.log("Audio context closed");
					}).catch((error) => {
						console.error("Error closing audio context: ", error);
					});
		
					const resultDiv = document.getElementById('respiratoryResult');
					const stopButton = document.getElementById('stopRespiratoryButton');
					const startButton = document.getElementById('startRespiratoryButton');
					const warningMessage = document.getElementById('respiratoryWarningMessage');
					const recommendationDiv = document.getElementById('respiratoryRecommendation');
		
					resultDiv.innerText = "Monitoring stopped";
					stopButton.style.display = 'none';
					startButton.style.display = 'inline';
					warningMessage.style.display = 'none';
					recommendationDiv.style.display = 'none';
				});
			</script>
		</body>
		</html>
		
  </section>
  {% include 'float.html' %}


<script src="{% static 'js/script.js' %}"></script>

